@model IEnumerable<WebApp.Models.Project>

@{
    ViewData["Title"] = "Projects";
    var orgName = ViewBag.OrganizationName as string;
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4">Volunteer Projects</h1>
            @if (!string.IsNullOrEmpty(orgName))
            {
                <p class="lead">Showing projects for: <strong>@orgName</strong></p>
            }
        </div>
        <a asp-action="Create" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Create New Project
        </a>
    </div>

    @if (!string.IsNullOrEmpty(orgName))
    {
        <div class="mb-3">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Show All Projects
            </a>
        </div>
    }

    @if (Model.Any())
    {
        <div class="row">
            @foreach (var project in Model)
            {
                var spotsLeft = project.MaxVolunteers - project.CurrentVolunteers;
                var percentFull = (project.CurrentVolunteers * 100.0) / project.MaxVolunteers;
                var progressColor = percentFull >= 90 ? "bg-danger" : percentFull >= 70 ? "bg-warning" : "bg-success";
                var statusBadge = project.Status switch
                {
                    ProjectStatus.Published => "badge bg-success",
                    ProjectStatus.Draft => "badge bg-secondary",
                    ProjectStatus.InProgress => "badge bg-primary",
                    ProjectStatus.Completed => "badge bg-info",
                    ProjectStatus.Cancelled => "badge bg-danger",
                    _ => "badge bg-secondary"
                };

                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-truncate" title="@project.Title">@project.Title</h5>
                            <span class="@statusBadge ms-2">@project.Status</span>
                        </div>
                        <div class="card-body">
                            <p class="card-text">@project.Description</p>

                            <div class="mb-2">
                                <strong><i class="bi bi-geo-alt-fill text-primary"></i> Location:</strong><br/>
                                <small>@project.Location, @project.City</small>
                            </div>

                            <div class="mb-2">
                                <strong><i class="bi bi-calendar-event text-primary"></i> Date:</strong><br/>
                                <small>
                                    @project.StartDate.ToString("dd/MM/yyyy")
                                    @if (project.StartDate.Date != project.EndDate.Date)
                                    {
                                        <span> - @project.EndDate.ToString("dd/MM/yyyy")</span>
                                    }
                                </small>
                            </div>

                            <div class="mb-2">
                                <strong><i class="bi bi-hourglass-split text-primary"></i> Application Deadline:</strong><br/>
                                <small class="@(project.ApplicationDeadline < DateTime.UtcNow.AddDays(3) ? "text-danger fw-bold" : "")">
                                    @project.ApplicationDeadline.ToString("dd/MM/yyyy")
                                </small>
                            </div>

                            <div class="mb-2">
                                <strong><i class="bi bi-people-fill text-primary"></i> Volunteers:</strong><br/>
                                <div class="d-flex align-items-center">
                                    <div class="progress flex-grow-1 me-2" style="height: 20px;">
                                        <div class="progress-bar @progressColor" 
                                             role="progressbar" 
                                             style="width: @percentFull%" 
                                             aria-valuenow="@project.CurrentVolunteers" 
                                             aria-valuemin="0" 
                                             aria-valuemax="@project.MaxVolunteers">
                                        </div>
                                    </div>
                                    <small class="text-nowrap">@project.CurrentVolunteers/@project.MaxVolunteers</small>
                                </div>
                                <small class="text-muted">@spotsLeft spots left</small>
                            </div>

                            @if (project.RequiredSkills.Any())
                            {
                                <div class="mb-2">
                                    <strong><i class="bi bi-star-fill text-primary"></i> Required Skills:</strong><br/>
                                    <div class="mt-1">
                                        @foreach (var skill in project.RequiredSkills)
                                        {
                                            <span class="badge bg-primary me-1 mb-1">@skill</span>
                                        }
                                    </div>
                                </div>
                            }

                            @if (project.Categories.Any())
                            {
                                <div class="mb-2">
                                    <strong><i class="bi bi-tag-fill text-primary"></i> Categories:</strong><br/>
                                    <div class="mt-1">
                                        @foreach (var category in project.Categories)
                                        {
                                            <span class="badge bg-secondary me-1 mb-1">@category</span>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                        <div class="card-footer bg-light">
                            <div class="btn-group w-100" role="group">
                                <a asp-action="Details" asp-route-id="@project.Id" class="btn btn-sm btn-outline-primary">
                                    <i class="bi bi-eye"></i> Details
                                </a>
                                <a asp-action="Edit" asp-route-id="@project.Id" class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-pencil"></i> Edit
                                </a>
                                <a asp-controller="Applications" asp-action="Manage" asp-route-projectId="@project.Id" class="btn btn-sm btn-outline-info">
                                    <i class="bi bi-file-text"></i> Applications
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            @if (!string.IsNullOrEmpty(orgName))
            {
                <span>No projects found for this organization. <a asp-action="Create">Create one now!</a></span>
            }
            else
            {
                <span>No projects found. <a asp-action="Create">Create the first one!</a></span>
            }
        </div>
    }
</div>

@section Scripts {
    <script>

    </script>
}
